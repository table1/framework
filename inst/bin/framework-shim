#!/usr/bin/env bash
# Framework CLI - Global Shim
#
# This shim provides project-aware CLI routing:
# 1. Searches upward from PWD for a local bin/framework
# 2. If found, executes it with all arguments
# 3. If not found, executes framework-global
# 4. If neither exists, shows helpful error
#
# Installed to: ~/.local/bin/framework

# Don't use set -e here - we want to handle errors gracefully

# Search upward for local bin/framework
find_local_framework() {
  local dir="$PWD"

  while [ "$dir" != "/" ]; do
    if [ -x "$dir/bin/framework" ]; then
      echo "$dir/bin/framework"
      return 0
    fi
    dir=$(dirname "$dir")
  done

  return 1
}

# Try to find local bin/framework
LOCAL_FRAMEWORK=$(find_local_framework)

if [ -n "$LOCAL_FRAMEWORK" ]; then
  # Execute local bin/framework with all arguments
  exec "$LOCAL_FRAMEWORK" "$@"
fi

# No local bin/framework found, try framework-global
# First check if it's in PATH
if command -v framework-global >/dev/null 2>&1; then
  exec framework-global "$@"
fi

# Try framework-global in same directory as this shim
# Use readlink -f if available (GNU), otherwise try realpath (macOS/BSD)
if command -v readlink >/dev/null 2>&1 && readlink -f "$0" >/dev/null 2>&1; then
  SHIM_DIR=$(dirname "$(readlink -f "$0")")
elif command -v realpath >/dev/null 2>&1; then
  SHIM_DIR=$(dirname "$(realpath "$0")")
else
  # Fallback: resolve symlink manually
  SHIM_PATH="$0"
  while [ -L "$SHIM_PATH" ]; do
    SHIM_PATH=$(readlink "$SHIM_PATH")
  done
  SHIM_DIR=$(cd "$(dirname "$SHIM_PATH")" && pwd)
fi

if [ -x "$SHIM_DIR/framework-global" ]; then
  exec "$SHIM_DIR/framework-global" "$@"
fi

# Neither found - show helpful error
cat >&2 <<EOF
Error: Framework CLI not found

This global 'framework' shim searches for:
  1. Project-local bin/framework (searched upward from $PWD)
  2. Global framework-global command

Neither was found. To fix this:

  1. Install framework-global:
     Rscript -e "framework::cli_install()"

  2. Or create a Framework project:
     curl -fsSL https://raw.githubusercontent.com/table1/framework-project/main/new-project.sh | bash

More info: https://github.com/table1/framework
EOF

exit 1
