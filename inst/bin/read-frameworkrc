#!/usr/bin/env Rscript
# Helper script to read .framework.yml and output shell variables
suppressWarnings(suppressMessages({
  library(yaml)
}))

framework_yml <- file.path(Sys.getenv("HOME"), ".framework.yml")
frameworkrc <- file.path(Sys.getenv("HOME"), ".frameworkrc")

# Migrate old .frameworkrc to .framework.yml
if (file.exists(frameworkrc) && !file.exists(framework_yml)) {
  file.rename(frameworkrc, framework_yml)
}

config_file <- if (file.exists(framework_yml)) framework_yml else frameworkrc

if (!file.exists(config_file)) {
  cat("# No config found\n")
  quit(status = 0)
}

config <- tryCatch({
  yaml::read_yaml(config_file)
}, error = function(e) {
  # If YAML parsing fails, return empty
  list()
})

# Output shell variables
if (!is.null(config$author$name)) {
  cat(sprintf('FW_AUTHOR_NAME="%s"\n', config$author$name))
}
if (!is.null(config$author$email)) {
  cat(sprintf('FW_AUTHOR_EMAIL="%s"\n', config$author$email))
}
if (!is.null(config$author$affiliation)) {
  cat(sprintf('FW_AUTHOR_AFFILIATION="%s"\n', config$author$affiliation))
}
if (!is.null(config$defaults$notebook_format)) {
  cat(sprintf('FW_DEFAULT_FORMAT="%s"\n', config$defaults$notebook_format))
}
if (!is.null(config$defaults$ide)) {
  cat(sprintf('FW_IDES="%s"\n', config$defaults$ide))
}

# AI settings if present
if (!is.null(config$ai$support)) {
  cat(sprintf('FW_AI_SUPPORT="%s"\n', config$ai$support))
}
if (!is.null(config$ai$assistants)) {
  cat(sprintf('FW_AI_ASSISTANTS="%s"\n', config$ai$assistants))
}
if (!is.null(config$ai$canonical_default)) {
  cat(sprintf('FW_AI_CANONICAL_DEFAULT="%s"\n', config$ai$canonical_default))
}

# Config directory preference
if (!is.null(config$defaults$config_dir)) {
  cat(sprintf('FW_CONFIG_DIR="%s"\n', config$defaults$config_dir))
}
